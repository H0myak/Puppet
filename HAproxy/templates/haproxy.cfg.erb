global
  log         127.0.0.1 local2
  chroot      /var/lib/haproxy
  pidfile     /var/run/haproxy.pid
  maxconn     4000
  user        haproxy
  group       haproxy
  daemon
  stats socket /var/lib/haproxy/stats

defaults
  log     global
  mode    http
  option  httplog
  option  dontlognull
  retries 3
  option redispatch
  maxconn 10000
  option httpclose
  option forwardfor
  timeout connect 5000
  timeout client  50000
  timeout server  50000

<% if @redis == true -%>
frontend <%= @redis_cluster %>-frontend
  mode tcp
  bind 0.0.0.0:<%= @redis_listen %>
  default_backend <%= @redis_cluster %>-backend

backend <%= @redis_cluster %>-backend
  mode tcp
  option tcplog
  option tcp-check
  tcp-check send AUTH\ <%= @redis_pass%>\r\n
  tcp-check expect string +OK
  tcp-check send PING\r\n
  tcp-check expect string +PONG
  tcp-check send info\ replication\r\n
  tcp-check expect string role:master
  tcp-check send QUIT\r\n
  tcp-check expect string +OK
  <% @redis_node.each do |hash| %>server <%= hash['servername'] %> <%= hash['ip'] %>:<%= hash['port'] %> maxconn 4096 check inter 3s
  <% end %>
<% end -%>
